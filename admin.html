<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Youth Service Philippines</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
    
    .header { background: linear-gradient(135deg, #fff 0%, #fff5f0 100%); border-bottom: 3px solid #ff8c42; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 1rem 0; }
    .nav-container { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; max-width: 1400px; margin: 0 auto; }
    .logo { display: flex; align-items: center; gap: 0.8rem; }
    .logo-icon { width: 50px; height: 50px; border-radius: 50%; object-fit: contain; }
    .logo-text h2 { font-size: 1.3rem; margin: 0; font-weight: 700; }
    .logo-text p { color: #ff8c42; margin: 0; font-weight: 600; }
    .nav-links { display: flex; list-style: none; gap: 2rem; }
    .nav-links a { text-decoration: none; color: #333; font-weight: 500; }
    .sign-in-btn { background: #ff8c42; color: white; padding: 0.6rem 1rem; border-radius: 5px; display: flex; align-items: center; gap: 0.5rem; text-decoration: none; font-weight: 600; }

    .admin-header { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: flex-start; }
    .admin-header h1 { font-size: 2.2rem; color: #333; font-weight: 700; margin-bottom: 0.25rem; }
    .admin-header .subtitle { color: #ff8c42; font-size: 0.95rem; }
    .back-btn { background: white; color: #333; border: 1px solid #e0e0e0; padding: 0.6rem 1.2rem; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 0.9rem; }
    .back-btn:hover { background: #f9f9f9; }

    .stats-grid { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #ff8c42; }
    .stat-card .label { color: #666; font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; }
    .stat-card .value { font-size: 2.2rem; font-weight: 800; color: #333; }
    .stat-card .icon { float: right; font-size: 2rem; color: #ffd9c0; }

    /* Program card adjustments for admin */
    .program-card { background: white; border-radius: 10px; box-shadow: 0 6px 18px rgba(17,24,39,0.06); overflow: hidden; border: 1px solid #eef2f6; display:flex; flex-direction:column; }
    .program-card .program-img { width:100%; height:140px; object-fit:cover; background:#f6f7f9; display:block; }
    .program-card .program-body { padding:12px; display:flex; flex-direction:column; gap:8px; }
    .program-card input[type="text"], .program-card textarea { width:100%; border:1px solid #e6e9ee; padding:8px; border-radius:6px; font-size:0.95rem; }
    .program-card .controls { display:flex; gap:8px; align-items:center; }

    /* Toast notifications */
    .toast-container { position: fixed; right: 20px; bottom: 20px; z-index: 9999; display:flex; flex-direction:column; gap:8px; }
    .toast { min-width: 220px; max-width: 320px; padding: 10px 14px; border-radius: 8px; color: #fff; box-shadow: 0 6px 18px rgba(17,24,39,0.08); font-weight:600; font-size:0.95rem; opacity:0; transform:translateY(8px); transition:all 260ms ease; }
    .toast.show { opacity:1; transform:translateY(0); }
    .toast.success { background: linear-gradient(90deg,#16a34a,#34d399); }
    .toast.warn { background: linear-gradient(90deg,#f59e0b,#fb923c); }
    .toast.error { background: linear-gradient(90deg,#ef4444,#f97316); }

    .quick-actions { max-width: 1400px; margin: 2rem auto; padding: 2rem; background: linear-gradient(135deg, #ff6a00 0%, #ff8c42 100%); border-radius: 12px; }
    .quick-actions h3 { color: white; font-size: 1.3rem; margin-bottom: 1.25rem; }
    .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; }
    .action-btn { background: transparent; color: white; border: 2px solid rgba(255,255,255,0.3); padding: 0.7rem 1.3rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
    .action-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.6); }

    .tabs-section { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
    .tabs-nav { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid #e0e0e0; }
    .tab-btn { background: transparent; border: none; padding: 1rem 1.5rem; cursor: pointer; font-weight: 600; color: #999; font-size: 0.95rem; position: relative; }
    .tab-btn.active { color: #333; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background: #ff8c42; }
    .tab-btn:hover { color: #333; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .stats-box { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .stats-box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .stats-box h3 { font-size: 1.2rem; color: #333; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
    .stats-box h3 i { color: #ff8c42; font-size: 1.3rem; }
    .edit-btn { background: white; color: #333; border: 1px solid #e0e0e0; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
    .edit-btn:hover { background: #f9f9f9; }

    .stats-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; }
    .stats-item { text-align: left; }
    .stats-item .label { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 500; }
    .stats-item .number { font-size: 2rem; font-weight: 800; color: #333; }

    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .action-buttons { gap: 0.75rem; }
      .action-btn { padding: 0.6rem 1rem; font-size: 0.85rem; }
    }

    @media (max-width: 768px) {
      .admin-header { flex-direction: column; gap: 1rem; }
      .stats-grid { grid-template-columns: 1fr; }
      .tabs-nav { overflow-x: auto; }
      .action-buttons { gap: 0.5rem; }
      .action-btn { flex: 1 1 calc(50% - 0.25rem); }
    }

    /* Modal styles */
    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 5000;
    }
    .modal-overlay.active { display: flex; }
    .modal-content { 
      background: white; 
      border-radius: 12px; 
      padding: 2rem; 
      max-width: 500px; 
      width: 90%; 
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header { 
      font-size: 1.5rem; 
      font-weight: 700; 
      margin-bottom: 1.5rem; 
      color: #333;
    }
    .form-group { 
      margin-bottom: 1.2rem; 
    }
    .form-group label { 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: 600; 
      color: #333;
      font-size: 0.95rem;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group input[type="file"] {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.95rem;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    .image-preview {
      margin-top: 0.8rem;
      width: 100%;
      height: 180px;
      border-radius: 6px;
      object-fit: cover;
      background: #f5f5f5;
      display: none;
    }
    .image-preview.active { display: block; }
    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 0.7rem 1.5rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .modal-btn.primary {
      background: #ff8c42;
      color: white;
    }
    .modal-btn.primary:hover { background: #e67e36; }
    .modal-btn.secondary {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #e0e0e0;
    }
    .modal-btn.secondary:hover { background: #e8e8e8; }
    .modal-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>


<!-- ADMIN HEADER -->
<div class="admin-header">
  <div>
    <h1>Admin Dashboard</h1>
    <p class="subtitle">Manage YSP website content and settings</p>
  </div>
  <a href="index.html" class="back-btn">Back to Website</a>
</div>

<!-- STATS GRID removed: admin dashboard now manages stats via the Statistics tab -->

<!-- QUICK ACTIONS -->
<div class="quick-actions">
  <h3>Quick Actions</h3>
  <div class="action-buttons">
    <button class="action-btn"><i class="fas fa-plus"></i> Add Program</button>
    <button class="action-btn"><i class="fas fa-plus"></i> Add Chapter</button>
    <button class="action-btn"><i class="fas fa-plus"></i> Add Event</button>
    <button class="action-btn"><i class="fas fa-plus"></i> Add Member</button>
  </div>
</div>

<!-- TABS SECTION -->
<div class="tabs-section">
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="statistics">Statistics</button>
    <button class="tab-btn" data-tab="programs">Programs</button>
    <button class="tab-btn" data-tab="chapters">Chapters</button>
    <button class="tab-btn" data-tab="events">Events</button>
    <button class="tab-btn" data-tab="members">Members</button>
    <button class="tab-btn" data-tab="contact">Contact</button>
  </div>

  <!-- Statistics Tab -->
  <div class="tab-content active" id="statistics">
    <div class="stats-box">
      <div class="stats-box-header">
        <h3><i class="fas fa-chart-bar"></i> Website Statistics</h3>
        <button class="edit-btn"><i class="fas fa-edit"></i> Edit</button>
      </div>
      <div class="stats-items">
        <div class="stats-item">
          <div class="label">Projects Completed</div>
          <div class="number" data-stat="projects">150</div>
        </div>
        <div class="stats-item">
          <div class="label">Active Chapters</div>
          <div class="number" data-stat="chapters">12</div>
        </div>
        <div class="stats-item">
          <div class="label">Active Members</div>
          <div class="number" data-stat="members">500</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Programs Tab -->
  <div class="tab-content" id="programs">
    <div class="stats-box">
      <h3>Programs Management</h3>
      <p style="color: #666; margin-top: 1rem;">Manage programs below. Changes save to localStorage and update public pages in real time.</p>
      <div style="margin-top:1rem; display:flex; gap:0.5rem;">
        <button id="add-program-btn" class="action-btn" style="background:#fff; color:#333; border:1px solid #e0e0e0;">+ Add Program</button>
      </div>
      <div id="admin-programs-list" style="margin-top:1.25rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem;"></div>
    </div>
  </div>

  <!-- Chapters Tab -->
  <div class="tab-content" id="chapters">
    <div class="stats-box">
      <h3>Chapters Management</h3>
      <p style="color: #666; margin-top: 1rem;">Chapters management interface coming soon.</p>
    </div>
  </div>

  <!-- Events Tab -->
  <div class="tab-content" id="events">
    <div class="stats-box">
      <h3>Events Management</h3>
      <p style="color: #666; margin-top: 1rem;">Events management interface coming soon.</p>
    </div>
  </div>

  <!-- Members Tab -->
  <div class="tab-content" id="members">
    <div class="stats-box">
      <h3>Members Management</h3>
      <p style="color: #666; margin-top: 1rem;">Members management interface coming soon.</p>
    </div>
  </div>

  <!-- Contact Tab -->
  <div class="tab-content" id="contact">
    <div class="stats-box">
      <h3>Contact Information</h3>
      <p style="color: #666; margin-top: 1rem;">Contact management interface coming soon.</p>
    </div>
  </div>
</div>

<!-- Program Modal -->
<div class="modal-overlay" id="program-modal">
  <div class="modal-content">
    <div class="modal-header" id="modal-header">Add Program</div>
    <form id="program-form">
      <div class="form-group">
        <label for="program-title">Program Title</label>
        <input type="text" id="program-title" placeholder="e.g., Education for All" required>
      </div>
      <div class="form-group">
        <label for="program-description">Description</label>
        <textarea id="program-description" placeholder="Describe the program..." required></textarea>
      </div>
      <div class="form-group">
        <label for="program-image">Program Image <span id="image-required">(required)</span></label>
        <input type="file" id="program-image" accept="image/*">
        <img id="image-preview" class="image-preview" alt="Image preview">
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-btn secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="modal-btn primary" id="save-program-btn">Save Program</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const tabName = this.getAttribute('data-tab');
      
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active from all buttons
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active');
      });
      
      // Show selected tab and mark button as active
      document.getElementById(tabName).classList.add('active');
      this.classList.add('active');
    });
  });

  // Statistics editing and localStorage sync
  (function(){
    const storageKey = 'ysp_stats';

    function seedFromDOM(){
      const seed = {};
      document.querySelectorAll('.stats-item .number').forEach(el => {
        const key = el.getAttribute('data-stat');
        if(key) seed[key] = el.textContent.trim();
      });
      return seed;
    }

    function getStats(){
      const raw = localStorage.getItem(storageKey);
      if(raw) return JSON.parse(raw);
      const s = seedFromDOM();
      localStorage.setItem(storageKey, JSON.stringify(s));
      return s;
    }

    function applyStatsToAdmin(stats){
      document.querySelectorAll('.stats-item .number').forEach(el => {
        const key = el.getAttribute('data-stat');
        if(key && stats[key] != null) el.textContent = stats[key];
      });
    }

    const stats = getStats();
    applyStatsToAdmin(stats);

    const editBtn = document.querySelector('.edit-btn');
    editBtn.addEventListener('click', function(){
      const isEditing = this.dataset.mode === 'editing';
      if(!isEditing){
        // enter editing mode
        this.innerHTML = '<i class="fas fa-save"></i> Save';
        this.dataset.mode = 'editing';
        document.querySelectorAll('.stats-item .number').forEach(el => {
          const key = el.getAttribute('data-stat');
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.value = el.textContent.trim();
          input.className = 'stats-input';
          input.style.width = '100%';
          input.style.fontSize = '1.6rem';
          input.style.fontWeight = '800';
          input.setAttribute('data-stat', key);
          el.replaceWith(input);
        });
      } else {
        // save
        const inputs = document.querySelectorAll('.stats-input');
        const newStats = getStats();
        inputs.forEach(inp => {
          const k = inp.getAttribute('data-stat');
          newStats[k] = inp.value;
          const div = document.createElement('div');
          div.className = 'number';
          div.setAttribute('data-stat', k);
          div.textContent = inp.value;
          inp.replaceWith(div);
        });
        localStorage.setItem(storageKey, JSON.stringify(newStats));
        this.innerHTML = '<i class="fas fa-edit"></i> Edit';
        this.dataset.mode = '';
      }
    });

    // update admin UI when changes happen in other tabs
    window.addEventListener('storage', function(e){
      if(e.key === storageKey && e.newValue){
        applyStatsToAdmin(JSON.parse(e.newValue));
      }
    });
  })();

  // Programs admin editor with Supabase integration
  (function(){
    const SUPABASE_URL = 'https://grpkcerqjfdpfttwpngf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdycGtjZXJxamZkcGZ0dHdwbmdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzg2OTcsImV4cCI6MjA4NjkxNDY5N30.8gyM-pyCVI4RIe2kmeRcKM_4BDjg0pQkXuX4JSZQ0nQ';

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentEditingId = null;
    let programsCache = [];

    // Verify Supabase connection
    console.log('ðŸ”— Supabase initialized:', { url: SUPABASE_URL });

    // Modal functions
    window.closeModal = function(){
      document.getElementById('program-modal').classList.remove('active');
      document.getElementById('program-form').reset();
      document.getElementById('image-preview').classList.remove('active');
      currentEditingId = null;
    };

    function openModal(isEdit, program = null){
      const modal = document.getElementById('program-modal');
      const header = document.getElementById('modal-header');
      const form = document.getElementById('program-form');
      const imageInput = document.getElementById('program-image');
      const imageRequired = document.getElementById('image-required');
      
      if(isEdit && program){
        header.textContent = 'Edit Program';
        document.getElementById('program-title').value = program.title;
        document.getElementById('program-description').value = program.description;
        currentEditingId = program.id;
        imageInput.removeAttribute('required');
        imageRequired.textContent = '(optional - leave blank to keep current image)';
        
        // Show image preview if exists
        if(program.image_data){
          const preview = document.getElementById('image-preview');
          preview.src = program.image_data;
          preview.classList.add('active');
        }
      } else {
        header.textContent = 'Add Program';
        form.reset();
        document.getElementById('image-preview').classList.remove('active');
        currentEditingId = null;
        imageInput.setAttribute('required', 'required');
        imageRequired.textContent = '(required)';
      }
      
      modal.classList.add('active');
    }

    window.editProgram = function(id){
      const program = programsCache.find(p => p.id === id);
      if(program) openModal(true, program);
    };

    // Image preview
    document.getElementById('program-image').addEventListener('change', function(){
      const file = this.files[0];
      if(!file) return;
      
      // Compress image before preview
      compressImage(file, (compressedBase64) => {
        const preview = document.getElementById('image-preview');
        preview.src = compressedBase64;
        preview.classList.add('active');
        showToast('Image compressed and ready', 'success');
      });
    });

    // Image compression function
    function compressImage(file, callback){
      const reader = new FileReader();
      reader.onload = function(event){
        const img = new Image();
        img.onload = function(){
          const canvas = document.createElement('canvas');
          const MAX_WIDTH = 800;
          const MAX_HEIGHT = 600;
          let width = img.width;
          let height = img.height;

          // Calculate new dimensions
          if(width > height){
            if(width > MAX_WIDTH){
              height = Math.round((height * MAX_WIDTH) / width);
              width = MAX_WIDTH;
            }
          } else {
            if(height > MAX_HEIGHT){
              width = Math.round((width * MAX_HEIGHT) / height);
              height = MAX_HEIGHT;
            }
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // Compress to JPEG with lower quality
          const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
          console.log(`ðŸ“¸ Image compressed: ${(file.size / 1024).toFixed(2)}KB â†’ ${(compressedBase64.length / 1024).toFixed(2)}KB`);
          callback(compressedBase64);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Form submission
    document.getElementById('program-form').addEventListener('submit', async function(e){
      e.preventDefault();
      
      const title = document.getElementById('program-title').value;
      const desc = document.getElementById('program-description').value;
      const imageInput = document.getElementById('program-image');
      const saveBtn = document.getElementById('save-program-btn');
      
      // Validate that image is provided for new programs
      if(!currentEditingId && !imageInput.files[0]){
        showToast('Please select an image for the program', 'error');
        return;
      }
      
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading-spinner"></span>';

      try {
        let imageData = null;
        
        // If a new image is selected, compress it
        if(imageInput.files[0]){
          const file = imageInput.files[0];
          
          imageData = await new Promise((resolve) => {
            compressImage(file, (compressedBase64) => {
              resolve(compressedBase64);
            });
          });
        } else if(currentEditingId){
          // If editing and no new image, keep the old one
          const existing = programsCache.find(p => p.id === currentEditingId);
          imageData = existing ? existing.image_data : null;
        }

        if(currentEditingId){
          // Update existing program
          console.log('ðŸ“ Updating program:', currentEditingId);
          const { error } = await supabase
            .from('programs')
            .update({
              title: title,
              description: desc,
              image_data: imageData,
              updated_at: new Date()
            })
            .eq('id', currentEditingId);

          if(error) throw error;
          console.log('âœ… Program updated successfully');
          showToast('Program updated successfully', 'success');
        } else {
          // Insert new program
          console.log('âž• Adding new program');
          const { error } = await supabase
            .from('programs')
            .insert([{
              title: title,
              description: desc,
              image_data: imageData
            }]);

          if(error) throw error;
          console.log('âœ… Program added successfully');
          showToast('Program added successfully', 'success');
        }

        window.closeModal();
        await loadPrograms();
      } catch (error) {
        console.error('Error saving program:', error);
        showToast('Error saving program: ' + error.message, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'Save Program';
      }
    });

    // Load programs from Supabase
    async function loadPrograms(){
      try {
        console.log('ðŸ“¦ Loading programs from Supabase...');
        const { data, error } = await supabase
          .from('programs')
          .select('*')
          .order('created_at', { ascending: true });

        if(error){
          console.error('âŒ Supabase error:', error);
          throw error;
        }
        
        programsCache = data || [];
        console.log('âœ… Programs loaded:', programsCache.length, 'programs');
        renderPrograms();
      } catch (error) {
        console.error('Error loading programs:', error);
        showToast('Error loading programs: ' + error.message, 'error');
      }
    }

    // Render programs
    function renderPrograms(){
      const container = document.getElementById('admin-programs-list');
      if(!container) return;
      
      container.innerHTML = '';
      
      programsCache.forEach(program => {
        const card = document.createElement('div');
        card.className = 'program-card';
        
        const img = document.createElement('img');
        img.className = 'program-img';
        img.src = program.image_data || '';
        img.alt = program.title;
        
        const body = document.createElement('div');
        body.className = 'program-body';
        
        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.style.fontSize = '0.95rem';
        title.textContent = program.title;
        
        const desc = document.createElement('div');
        desc.style.fontSize = '0.85rem';
        desc.style.color = '#666';
        desc.style.lineHeight = '1.4';
        desc.textContent = program.description.substring(0, 100) + (program.description.length > 100 ? '...' : '');
        
        const controls = document.createElement('div');
        controls.className = 'controls';
        controls.style.gap = '0.5rem';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'action-btn';
        editBtn.style.background = '#ff8c42';
        editBtn.style.color = '#fff';
        editBtn.style.border = 'none';
        editBtn.style.flex = '1';
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
        editBtn.onclick = () => window.editProgram(program.id);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'action-btn';
        deleteBtn.style.background = '#fff';
        deleteBtn.style.color = '#333';
        deleteBtn.style.border = '1px solid #e0e0e0';
        deleteBtn.style.flex = '1';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        deleteBtn.onclick = () => deleteProgram(program.id);
        
        controls.appendChild(editBtn);
        controls.appendChild(deleteBtn);
        
        body.appendChild(title);
        body.appendChild(desc);
        body.appendChild(controls);
        
        card.appendChild(img);
        card.appendChild(body);
        
        container.appendChild(card);
      });
    }

    // Delete program
    async function deleteProgram(id){
      if(!confirm('Are you sure you want to delete this program?')) return;
      
      try {
        const { error } = await supabase
          .from('programs')
          .delete()
          .eq('id', id);

        if(error) throw error;
        
        showToast('Program deleted successfully', 'warn');
        await loadPrograms();
      } catch (error) {
        console.error('Error deleting program:', error);
        showToast('Error deleting program: ' + error.message, 'error');
      }
    }

    window.deleteProgram = deleteProgram;

    // Add program button
    const addBtn = document.getElementById('add-program-btn');
    if(addBtn){
      addBtn.addEventListener('click', function(){
        openModal(false);
      });
    }

    // Real-time subscription
    const subscription = supabase
      .channel('programs_changes')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'programs' },
        (payload) => {
          console.log('ðŸ”„ Real-time update received:', payload);
          loadPrograms();
        }
      )
      .subscribe((status) => {
        console.log('ðŸ“¡ Real-time subscription status:', status);
      });

    // Initial load
    loadPrograms();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      supabase.removeChannel(subscription);
    });
  })();


  // Toast helper
  function showToast(message, type = 'success', duration = 3000){
    let container = document.querySelector('.toast-container');
    if(!container){ container = document.createElement('div'); container.className = 'toast-container'; document.body.appendChild(container); }
    const t = document.createElement('div'); t.className = 'toast ' + (type || 'success'); t.textContent = message;
    container.appendChild(t);
    // trigger animation
    requestAnimationFrame(()=> t.classList.add('show'));
    setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(),260); }, duration);
  }
</script>

</body>
</html>
